# v2.1 검사결과 워크플로우 대대적 변경사항

## 1. 명칭 및 메뉴 변경

| 기존 (v2.0) | 변경 후 (v2.1) | 설명 |
|---|---|---|
| 검사결과 (Lab Results) | **검사결과 등록** | 파일 업로드 중심, 입력 필드 없음 |
| AI 소견서 / AI Reports | **검사결과 승인** | AI 분석 → 의사 확인/승인 → 직원 열람 |
| lab_results 테이블 | **lab_uploads** + **lab_analyses** | 업로드와 분석을 분리 |
| ai_reports 테이블 | **lab_approvals** | 승인 워크플로우 전용 |
| AiReportStatus | **LabApprovalStatus** | 상태값 변경 |

### 메뉴 순서 변경

```
대시보드
├── ...기존 메뉴...
├── 검사결과 등록    ← 위 (기존 검사결과 위치)
├── 검사결과 승인    ← 아래 (기존 AI소견서 위치)
└── ...
```

---

## 2. 전체 워크플로우 (변경 후)

```
[검사결과 등록]                              [검사결과 승인]
─────────────                              ─────────────

① 파일 업로드                               ⑤ 분석완료 목록 확인
   (CSV/XLSX/PDF)                              (AI 코멘트 확인)
       │                                          │
       ▼                                          ▼
② 날짜별 업로드 현황                          ⑥ 의사: [승인] 버튼
   (파일 수 표시)                                  │
       │                                          ▼
       ▼                                   ⑦ 승인된 검사결과
③ [분석시작] 버튼                               (직원 열람 가능)
       │
       ▼
④ AI 분석 처리
   - 파일 파싱
   - 환자명 추출 → DB 저장
   - 이상치 판정 (룰 기반)
   - AI 코멘트 생성
   - 벡터DB 저장
   - 상태: 분석완료
```

---

## 3. DB 스키마 변경

### 3.1 새로운 테이블

```sql
-- 검사파일 업로드 기록
CREATE TABLE lab_uploads (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  uploaded_by   UUID NOT NULL REFERENCES "User"(id),
  file_name     TEXT NOT NULL,
  file_path     TEXT NOT NULL,           -- storage 경로
  file_size     INTEGER NOT NULL,        -- bytes
  file_type     TEXT NOT NULL,           -- csv, xlsx, pdf
  uploaded_date DATE NOT NULL,           -- 업로드 날짜 (그룹핑 키)
  status        TEXT NOT NULL DEFAULT 'PENDING',
                -- PENDING | ANALYZING | ANALYZED | FAILED
  error_message TEXT,                    -- 분석 실패 시 사유
  created_at    TIMESTAMPTZ DEFAULT now(),
  deleted_at    TIMESTAMPTZ
);

-- AI 분석 결과 (파일별)
CREATE TABLE lab_analyses (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  upload_id       UUID NOT NULL REFERENCES lab_uploads(id),
  patient_id      UUID REFERENCES "Patient"(id),  -- 추출된 환자
  patient_name    TEXT,                            -- 파일에서 추출한 원본 이름
  emr_patient_id  TEXT,                            -- 파일에서 추출한 차트번호
  parsed_data     JSONB,                           -- 파싱된 검사 수치 전체
  abnormal_count  INTEGER DEFAULT 0,
  normal_count    INTEGER DEFAULT 0,
  ai_comment      TEXT,                            -- AI 생성 코멘트
  ai_comment_at   TIMESTAMPTZ,
  vector_id       TEXT,                            -- 벡터DB 문서 ID
  status          TEXT NOT NULL DEFAULT 'PENDING',
                  -- PENDING | PARSED | ANALYZED | FAILED
  created_at      TIMESTAMPTZ DEFAULT now(),
  deleted_at      TIMESTAMPTZ
);

-- 검사결과 승인 (의사 → 직원 열람)
CREATE TABLE lab_approvals (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  upload_date     DATE NOT NULL,         -- 어떤 날짜 배치를 승인하는지
  analyses_ids    UUID[] NOT NULL,       -- 포함된 분석 ID 목록
  patient_summary JSONB,                 -- { totalPatients, abnormalPatients, ... }
  ai_summary      TEXT,                  -- 전체 요약 코멘트
  status          TEXT NOT NULL DEFAULT 'PENDING',
                  -- PENDING | APPROVED | REJECTED
  approved_by     UUID REFERENCES "User"(id),
  approved_at     TIMESTAMPTZ,
  stamped_at      TIMESTAMPTZ,
  rejection_note  TEXT,
  version         INTEGER DEFAULT 1,
  created_at      TIMESTAMPTZ DEFAULT now(),
  deleted_at      TIMESTAMPTZ
);
```

### 3.2 기존 테이블 유지

- `LabResult` 테이블: AI 분석 후 개별 검사 수치를 여기에 저장 (기존 호환)
- `Patient` 테이블: 파일에서 추출한 환자를 upsert

---

## 4. 검사결과 등록 페이지 상세

### 4.1 메인 화면 (목록)

```
┌─ 검사결과 등록 ──────────────────────────────────────┐
│                                                       │
│  [📁 파일 업로드]          ← 버튼 하나만 존재         │
│                                                       │
│  ─ 날짜별 업로드 현황 ──────────────────────────────  │
│                                                       │
│  📅 2026-02-05 (오늘)                                 │
│     파일 3건 업로드 | ⏳ 대기중                        │
│     [분석시작]  [결과보기]                              │
│                                                       │
│  📅 2026-02-04                                        │
│     파일 5건 업로드 | ✅ 분석완료                       │
│     [결과보기]                                         │
│                                                       │
│  📅 2026-02-03                                        │
│     파일 2건 업로드 | ✅ 분석완료 (승인됨)              │
│     [결과보기]                                         │
│                                                       │
└───────────────────────────────────────────────────────┘
```

### 4.2 핵심 규칙

- **입력 필드 없음**: 업로드 버튼만 존재. 파일명/날짜/크기는 자동 기록
- **업로드 후 표시**: 날짜별로 그룹핑하여 업로드된 파일 수만 표시
- **분석은 수동 트리거**: [분석시작] 버튼을 눌러야 AI 분석 시작
- **여러 파일 일괄 분석**: 같은 날짜의 대기 파일 전체를 한번에 분석

### 4.3 날짜별 상세 보기 (결과보기 클릭 시)

```
┌─ 2026-02-04 검사결과 상세 ────────────────────────┐
│                                                    │
│  파일 목록 (5건)                                    │
│  ──────────────────────────────────────────────    │
│  📄 혈액검사_20260204_001.xlsx    ✅ 분석완료       │
│     → 추출 환자: 김OO, 박OO, 이OO (3명)            │
│  📄 혈액검사_20260204_002.xlsx    ✅ 분석완료       │
│     → 추출 환자: 최OO, 정OO (2명)                  │
│  📄 혈액검사_20260204_003.csv     ✅ 분석완료       │
│     → 추출 환자: 한OO (1명)                        │
│  📄 소변검사_20260204.pdf         ⚠️ 분석실패       │
│     → 사유: PDF 텍스트 추출 불가                    │
│  📄 생화학검사_20260204.xlsx      ✅ 분석완료       │
│     → 추출 환자: 김OO, 강OO (2명)                  │
│                                                    │
│  전체 분석 요약                                     │
│  ──────────────────────────────────────────────    │
│  추출 환자 수: 8명 (중복 제거 후 7명)                │
│  이상치 발견: 4명                                   │
│  정상: 3명                                         │
│                                                    │
│  [← 목록으로]                                      │
└────────────────────────────────────────────────────┘
```

---

## 5. AI 분석 파이프라인 상세

### 5.1 분석 프로세스 ([분석시작] 버튼 클릭 시)

```
[분석시작] 클릭
    │
    ▼
Step 1: 파일 파싱
    - CSV/XLSX: openpyxl/pandas로 구조화
    - PDF: OCR/텍스트 추출 (실패 시 "분석실패" 처리)
    - 파싱 결과를 임시 구조화 데이터로 변환
    │
    ▼
Step 2: 환자명 추출 → DB 저장
    - 파일 내 환자 식별 정보(이름, 차트번호) 추출
    - Patient 테이블에 upsert (emr_patient_id 기준)
    - 신규 환자 → 자동 생성
    - 기존 환자 → 매핑 연결
    │
    ▼
Step 3: 이상치 판정 (룰 기반 — 1차)
    - 검사 항목별 result vs ref_low/ref_high
    - HIGH / LOW / NORMAL / UNDETERMINED 판정
    - 판정 로그 기록 (재현 가능)
    │
    ▼
Step 4: AI 코멘트 생성 (LLM — 2차)
    - 이상치 요약 + 임상적 주의사항 코멘트
    - 확정 진단/처방 표현 금지 (프롬프트 제어)
    - 응급 기준 해당 시 "[응급 주의]" 태그 자동 삽입
    │
    ▼
Step 5: 벡터DB 저장
    - 분석 결과 전체를 벡터 임베딩하여 저장
    - 용도: 환자별 검사 이력 유사도 검색, 트렌드 분석
    - 저장 데이터: 환자ID + 검사일 + 항목별 수치 + AI 코멘트
    │
    ▼
Step 6: 상태 업데이트
    - 해당 날짜의 업로드 배치 상태 → "분석완료"
    - 검사결과 등록 화면에 "✅ 분석완료" 표시
    - 이상치 있는 환자 → 의사 업무함에 자동 등록
```

### 5.2 AI 분석 코멘트 생성 프롬프트

```typescript
export function buildAnalysisCommentPrompt(
  patient: { name: string; sex: string; age: number },
  results: Array<{
    analyte: string;
    value: number;
    unit: string;
    refLow: number;
    refHigh: number;
    flag: string;
  }>
): string {
  return `
당신은 암요양병원의 검사결과 분석 보조 도구입니다.
아래 환자의 혈액검사 결과를 분석하여 코멘트를 작성하세요.

## 엄격한 규칙
- "확진", "진단 확정", "~으로 진단함" 등 확정적 표현 절대 금지
- 특정 약물 처방이나 투약 지시 절대 금지
- "가능성", "참고 정보", "추가 확인 필요" 등으로만 표현
- 응급 기준 해당 시 반드시 "[응급 주의]" 섹션 포함

## 응급 기준
- Hb < 7.0 g/dL
- PLT < 20,000 /μL
- WBC > 30,000 /μL 또는 < 1,000 /μL
- K > 6.0 mEq/L 또는 < 2.5 mEq/L
- Na < 120 mEq/L 또는 > 160 mEq/L
- Cr > 5.0 mg/dL (급성 상승 의심)

## 환자 정보
- 이름: ${patient.name}
- 성별: ${patient.sex === 'M' ? '남성' : '여성'}
- 나이: ${patient.age}세

## 검사 결과
${results.map(r =>
  `- ${r.analyte}: ${r.value} ${r.unit} (참고: ${r.refLow}-${r.refHigh}) [${r.flag}]`
).join('\n')}

## 출력 형식
1. 요약 (1-2문장)
2. 이상 수치 분석 (항목별)
3. 임상적 주의사항
4. [응급 주의] (해당 시에만)
`;
}
```

---

## 6. 검사결과 승인 페이지 상세

### 6.1 메인 화면

```
┌─ 검사결과 승인 ──────────────────────────────────────┐
│                                                       │
│  상태 필터: [전체] [승인대기] [승인됨] [반려]          │
│                                                       │
│  ─ 승인 대기 목록 ────────────────────────────────── │
│                                                       │
│  📋 2026-02-04 검사결과                               │
│     파일 5건 | 환자 7명 | 이상치 4명                   │
│     AI 분석: ✅ 완료                                  │
│     [상세보기]  [✅ 승인]  [❌ 반려]                   │
│                                                       │
│  ─ 승인 완료 ─────────────────────────────────────── │
│                                                       │
│  📋 2026-02-03 검사결과  ✅ 승인됨                     │
│     승인자: 김의사 | 승인일: 2026-02-03 15:30          │
│     [상세보기]  [PDF 다운로드]  [엑셀 다운로드]        │
│                                                       │
└───────────────────────────────────────────────────────┘
```

### 6.2 상세보기 (승인 전)

```
┌─ 2026-02-04 검사결과 상세 ────────────────────────────┐
│                                                        │
│  환자별 분석 결과                                       │
│  ─────────────────────────────────────────────────    │
│                                                        │
│  🔴 김OO (EMR-001) — 이상치 3건                        │
│     AI 코멘트: "WBC 상승(12,500)으로 감염 가능성...     │
│               Hb 저하(9.2)로 빈혈 추가 확인 필요..."    │
│     ┌──────────────────────────────────────────┐      │
│     │ 항목     수치    참고범위    판정          │      │
│     │ WBC     12,500  4,000-10,000  🔴 HIGH    │      │
│     │ Hb       9.2    13.0-17.0     🔵 LOW     │      │
│     │ PLT    180,000  150,000-400,000  정상     │      │
│     └──────────────────────────────────────────┘      │
│                                                        │
│  🟢 박OO (EMR-002) — 정상                              │
│     AI 코멘트: "전체 검사 수치 정상 범위입니다."         │
│                                                        │
│  🔴 이OO (EMR-003) — 이상치 1건                        │
│     AI 코멘트: "[응급 주의] K 6.3 mEq/L 확인..."       │
│                                                        │
│  ────────────────────────────────────────────────     │
│  전체 요약                                              │
│  총 환자 7명 | 이상치 4명 | 정상 3명                    │
│  응급 주의: 1명 (이OO — 칼륨 수치)                      │
│                                                        │
│  [✅ 전체 승인]  [❌ 반려]  [← 목록으로]               │
│                                                        │
│  승인 시 빨간 도장 (스탬프) 자동 적용                    │
│  → 직원이 "검사결과 승인" 메뉴에서 열람 가능             │
└────────────────────────────────────────────────────────┘
```

### 6.3 권한별 차이

| 계정 | 검사결과 등록 | 검사결과 승인 |
|---|---|---|
| **admin** (SuperAdmin) | 업로드, 분석시작 | 전체 보기, 승인/반려, 다운로드 |
| **doctor1** (의사) | 업로드, 분석시작 | 전체 보기, 승인/반려, 다운로드 |
| **nurse1** (간호사) | 업로드 | 승인된 것만 보기, 다운로드 |
| **staff1** (직원) | 업로드 | 승인된 것만 보기, 다운로드 |

---

## 7. 대시보드 현황 차트 개선

### 7.1 주별/월별 달력 뷰

기존 recharts 라인/바 차트에 추가로 **달력 형태의 히트맵** 뷰를 제공합니다.

```
┌─ 현황 추이 ──── [일별] [주별📅] [월별📅] ────────┐
│                                                    │
│  ── 2026년 2월 (월별 달력 뷰) ──                   │
│                                                    │
│  일   월   화   수   목   금   토                   │
│                          1    2                    │
│                         [3]  [1]                   │
│  3    4    5    6    7    8    9                    │
│ [2]  [5]  [3]  [4]  [6]  [2]  [0]                 │
│  10   11   12   13   14   15   16                  │
│ [1]  [4]  [7]  [3]  [5]  [2]  [0]                 │
│                                                    │
│  ※ 숫자 = 입원건수. 셀 배경색 = 건수에 따른 히트맵  │
│                                                    │
│  범례: 🟩 0-2건  🟨 3-5건  🟧 6-8건  🟥 9건 이상   │
│                                                    │
│  도메인 선택: [병상가동] [입원] [처치] [외래] [방문]  │
│                                                    │
└────────────────────────────────────────────────────┘
```

### 7.2 일별은 기존 차트 유지

- 일별: recharts LineChart/BarChart (기존 유지)
- 주별: 달력 히트맵 (주 단위 행)
- 월별: 달력 히트맵 (월 전체)

---

## 8. 변경 파일 목록

| 파일 | 작업 | 설명 |
|------|------|------|
| `apps/api/prisma/schema.prisma` | 수정 | LabUpload, LabAnalysis, LabApproval 모델 추가 |
| `apps/api/src/routes/labUploads.ts` | **신규** | 파일 업로드 + 분석 시작 API |
| `apps/api/src/routes/labApprovals.ts` | **신규** | 승인 워크플로우 API |
| `apps/api/src/services/labAnalysisService.ts` | **신규** | AI 분석 파이프라인 (파싱→추출→판정→코멘트→벡터) |
| `apps/api/src/routes/dashboard.ts` | 수정 | trends 엔드포인트에 달력 데이터 추가 |
| `apps/web/app/dashboard/lab-uploads/page.tsx` | **신규** | 검사결과 등록 페이지 (업로드 + 날짜별 현황) |
| `apps/web/app/dashboard/lab-approvals/page.tsx` | **신규** | 검사결과 승인 페이지 (AI 코멘트 + 승인) |
| `apps/web/app/dashboard/page.tsx` | 수정 | 주별/월별 달력 히트맵 추가 |
| `apps/web/app/dashboard/layout.tsx` | 수정 | 사이드바 메뉴 명칭/순서 변경 |
| `apps/web/stores/auth.ts` | 유지 | 변경 없음 |

---

## 9. API 엔드포인트

### 검사결과 등록 (labUploads)

| Method | 경로 | 설명 |
|--------|------|------|
| POST | `/api/lab-uploads` | 파일 업로드 (multipart/form-data) |
| GET | `/api/lab-uploads` | 날짜별 업로드 현황 목록 |
| GET | `/api/lab-uploads/:date` | 특정 날짜 상세 (파일 목록 + 분석 상태) |
| POST | `/api/lab-uploads/:date/analyze` | [분석시작] — AI 분석 파이프라인 실행 |

### 검사결과 승인 (labApprovals)

| Method | 경로 | 설명 |
|--------|------|------|
| GET | `/api/lab-approvals` | 승인 목록 (권한별 필터링) |
| GET | `/api/lab-approvals/:id` | 상세 (환자별 분석 결과 + AI 코멘트) |
| PATCH | `/api/lab-approvals/:id/approve` | 승인 (스탬프) |
| PATCH | `/api/lab-approvals/:id/reject` | 반려 |
| GET | `/api/lab-approvals/:id/export-pdf` | 스탬프 PDF 다운로드 |
| GET | `/api/lab-approvals/:id/export-excel` | 엑셀 다운로드 |

---

## 10. 구현 순서

1. Prisma 스키마 변경 (LabUpload, LabAnalysis, LabApproval 모델 추가)
2. 파일 업로드 API (`labUploads.ts`)
3. AI 분석 파이프라인 서비스 (`labAnalysisService.ts`)
4. 승인 워크플로우 API (`labApprovals.ts`)
5. 사이드바 메뉴 변경 (`layout.tsx`)
6. 검사결과 등록 프론트엔드 (`lab-uploads/page.tsx`)
7. 검사결과 승인 프론트엔드 (`lab-approvals/page.tsx`)
8. 대시보드 달력 히트맵 (`dashboard/page.tsx`)
9. 빌드 + 테스트
10. Cloud Run 재배포
